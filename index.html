<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지구과학 단답형/서술형 문제</title>
    <style>
        /* 기본 다크 모드 스타일 유지 */
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background-color: #2c2c2c;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        h1 {
            color: #8ab4f8;
            border-bottom: 2px solid #8ab4f8;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        /* 탭 버튼 스타일 */
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .tab-btn {
            padding: 15px 25px; /* 버튼 간격 조정 */
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            background-color: #383838;
            color: #aaa;
            border-radius: 10px 10px 0 0;
            transition: background-color 0.3s, color 0.3s;
            white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        }
        .tab-btn.active {
            background-color: #4a4a4a;
            color: #8ab4f8;
            border-bottom: 4px solid #8ab4f8;
        }
        .tab-btn:not(.active):hover {
            background-color: #444;
        }
        /* 퀴즈 영역 및 입력 스타일 (기존 유지) */
        #quiz-status { font-size: 1.2em; margin-bottom: 20px; color: #cccccc; }
        #question-box { min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; margin-bottom: 30px; background-color: #383838; border-radius: 10px; }
        #question-text { font-size: 1.4em; font-weight: bold; margin-bottom: 20px; line-height: 1.5; text-align: left; width: 100%; }
        #answer-input { width: 80%; padding: 12px; font-size: 1.1em; border: 2px solid #555; border-radius: 8px; background-color: #444; color: #e0e0e0; text-align: center; outline: none; transition: border-color 0.3s; }
        #answer-input:focus { border-color: #8ab4f8; }
        .essay-input-container { width: 90%; margin: 10px auto; }
        .essay-input-container textarea { width: 100%; height: 100px; padding: 10px; font-size: 1em; border: 2px solid #555; border-radius: 8px; background-color: #444; color: #e0e0e0; resize: vertical; outline: none; box-sizing: border-box; }
        #essay-answer-box { background-color: #444; border: 1px solid #666; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; display: none; }
        #essay-answer-box h4 { color: #8ab4f8; margin-top: 0; }
        #essay-score-buttons { margin-top: 10px; text-align: center; }
        .button-group { display: flex; justify-content: center; gap: 15px; }
        .quiz-button { padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        #check-button { background-color: #a8a8a8; color: #1a1a1a; }
        #next-button { background-color: #8ab4f8; color: #1a1a1a; display: none; }
        .essay-score-btn { padding: 8px 15px; font-size: 1em; margin: 0 5px; }
        .correct-btn { background-color: #85e085; color: #1a1a1a; }
        .incorrect-btn { background-color: #ff8a80; color: #1a1a1a; }
        .result { margin-top: 15px; font-size: 1.2em; font-weight: bold; min-height: 30px; }
        .correct { color: #85e085; }
        .incorrect { color: #ff8a80; }
        #final-score { margin-top: 40px; padding: 20px; border: 2px solid #8ab4f8; border-radius: 10px; font-size: 1.3em; }
        .quiz-button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h1>지구과학 단답형/서술형 문제</h1>

    <div class="tab-buttons">
        <button class="tab-btn active" id="short-tab-btn" onclick="setMode('short')">단답형 퀴즈</button>
        <button class="tab-btn" id="essay-tab-btn" onclick="setMode('essay')">서술형 퀴즈</button>
        <button class="tab-btn" id="review-tab-btn" onclick="setMode('review')">오답 노트 (0)</button>
    </div>

    <div id="quiz-content-area">
        <div id="quiz-status"></div>

        <div id="quiz-area">
            <div id="question-box">
                <div id="question-text"></div>
                <input type="text" id="answer-input" placeholder="정답을 입력하세요" style="display: none;"/>
                <div class="essay-input-container" id="essay-input-area" style="display: none;">
                    <textarea id="essay-user-answer" placeholder="답안을 서술하세요."></textarea>
                    <div id="essay-answer-box">
                        <h4>모범 답안</h4>
                        <pre id="essay-correct-answer" style="white-space: pre-wrap; font-family: inherit;"></pre>
                        <div id="essay-score-buttons">
                            <p>위의 모범 답안과 비교하여 채점해주세요.</p>
                            <button class="quiz-button essay-score-btn correct-btn" onclick="setEssayResult(true)">O (맞음)</button>
                            <button class="quiz-button essay-score-btn incorrect-btn" onclick="setEssayResult(false)">X (틀림)</button>
                        </div>
                    </div>
                </div>
                
                <div class="result" id="result-text"></div>
            </div>

            <div class="button-group">
                <button class="quiz-button" id="check-button" onclick="handleCheck()">Enter로 정답 확인</button>
                <button class="quiz-button" id="next-button" onclick="nextQuestion()" style="display: none;">Space/Enter로 다음 문제</button>
            </div>
        </div>
    </div>
    
    <div id="control-panel" style="margin-top: 20px;">
        <button class="quiz-button" onclick="resetIncorrectAnswers()" style="background-color: #ff6347; color: #1a1a1a;">오답 노트 전체 초기화</button>
    </div>

    <div id="final-score" style="display: none;"></div>
</div>

<script>
    // --- 원본 퀴즈 데이터 정의 (모든 팩트를 담은 소스) ---
    const sourceQuizData = [
        // --- 기존 단답형 문제 (26개) ---
        { type: "short", q: "기존 전력망에 정보통신기술을 접목해 전력 생산, 송전, 배전, 소비 전 과정을 실시간으로 모니터링하고 제어하는 차세대 전력망은 무엇인가요?", a: "스마트그리드", id: "s-1" },
        { type: "short", q: "휴대 전화 및 전자 기기를 이용하여 시간과 장소에 구애받지 않고 정보를 쉽게 처리하고 의사 소통이 가능한 기술은 무엇인가요?", a: "정보통신기술", id: "s-2" },
        { type: "short", q: "태양/풍력/수력 발전, 탄소 배출 감소, 에너지 저장 기술 등을 통해 지속 가능한 발전과 지구 환경 문제 해결에 도움을 주는 기술은 무엇인가요?", a: "신재생에너지기술", id: "s-3" },
        { type: "short", q: "드론이나 센서를 이용한 정밀 농업, 유전자 변형 작물, 수직 농업 등 식량 문제 해결에 기여하는 기술은 무엇인가요?", a: "농업기술", id: "s-4" },
        { type: "short", q: "MRI, CT, 첨단 영상 진단, 정밀 의학, 재생 의학 등을 통해 인간의 건강한 삶 유지에 기여하는 기술은 무엇인가요?", a: "의학기술", id: "s-5" },
        { type: "short", q: "인공지능 기술을 활용해 상황을 스스로 판단하며 자율적으로 움직이는 로봇은 무엇인가요?", a: "인공지능로봇", id: "s-6" },
        { type: "short", q: "사물에 센서와 통신 기술을 내장하고 인터넷에 연결하여 정보를 전송하고 통신하는 기술 (약자 포함)은 무엇인가요?", a: "사물인터넷(IoT)", id: "s-7" },
        { type: "short", q: "조명, 냉난방, 보안시스템 등을 스마트 기기로 제어하는 사물 인터넷 활용 예는 무엇인가요?", a: "홈자동화", id: "s-8" },
        { type: "short", q: "실시간 교통 정보를 분석, 조정하여 교통혼잡을 감소시키는 사물 인터넷 활용 예는 무엇인가요?", a: "스마트교통시스템", id: "s-9" },
        { type: "short", q: "환자의 데이터를 실시간으로 수집, 분석하여 효율적인 진료를 제공하는 사물 인터넷 활용 예는 무엇인가요?", a: "스마트병원", id: "s-10" },
        { type: "short", q: "생산 공정의 자동화로 생산성을 향상하고, 비용을 절감하며, 품질 관리를 강화하는 사물 인터넷 활용 예는 무엇인가요?", a: "스마트공장", id: "s-11" },
        { type: "short", q: "토양 수분, 기후 조건, 작물 성장 상태를 모니터링하여 농작물 생산성 향상시키는 사물 인터넷 활용 예는 무엇인가요?", a: "스마트농업", id: "s-12" },
        { type: "short", q: "매체 기술 발전의 한계로 나타나는 문제 중, 거짓 정보나 잘못된 정보가 퍼지는 것을 일컫는 말은 무엇인가요?", a: "가짜뉴스", id: "s-13" },
        { type: "short", q: "과학기술의 발전으로 나타나 다양한 사회 구성원들에게 논란을 일으키는 문제를 무엇이라고 하며, 약자는 무엇인가요?", a: "과학관련사회적쟁점(SSI)", id: "s-14" },
        { type: "short", q: "'Not In My Back Yard'의 약자로, 혐오 시설 등이 자신의 거주 지역에 들어오는 것을 반대하는 현상은?", a: "NIMBY", id: "s-15" },
        { type: "short", q: "'Please In My Front Yard'의 약자로, 이익이 되는 시설을 자기 거주 지역에 유치하려는 현상은?", a: "PIMFY", id: "s-16" },
        { type: "short", q: "과학기술을 연구하고, 이용할 때 윤리적 측면을 고려해 가치 판단 하는 것을 무엇이라고 하는가?", a: "과학윤리", id: "s-17" },
        { type: "short", q: "연구 절차와 결과를 조작하거나 거짓으로 만들어 내지 않고, 학문 발전을 위해 연구 내용을 공개하는 연구 윤리 항목은?", a: "정직성과개방성", id: "s-18" },
        { type: "short", q: "다른 과학자의 연구 결과를 함부로 사용하지 않는 연구 윤리 항목은?", a: "지식재산권존중", id: "s-19" },
        { type: "short", q: "실험 대상을 윤리적으로 대하여 실험 대상의 생명과 존엄성을 존중하는 연구 윤리 항목은?", a: "실험대상에대한존중", id: "s-20" },
        { type: "short", q: "사회에 악영향을 미치는 연구는 피하고, 공공의 이익을 위해 노력하는 연구 윤리 항목은?", a: "사회적책임", id: "s-21" },
        { type: "short", q: "안락사, 동물 실험, 배아 연구, 맞춤 아기 등과 관련된 과학 윤리의 구분 분야는?", a: "생명윤리", id: "s-22" },
        { type: "short", q: "유전자 재조합, 줄기세포 연구, 인간 복제 등과 관련된 과학 윤리의 구분 분야는?", a: "유전공학", id: "s-23" },
        { type: "short", q: "핵발전, 방사성 폐기물, 해양 자원의 이용 등과 관련된 과학 윤리의 구분 분야는?", a: "에너지", id: "s-24" },
        { type: "short", q: "기후 변화, 미세 먼지, 생물종 감소 등과 관련된 과학 윤리의 구분 분야는?", a: "환경,생태계", id: "s-25" },
        { type: "short", q: "나노 기술, 로봇, 식량 자원, 우주 항해, 드론 사용 범위 등과 관련된 과학 윤리의 구분 분야는?", a: "기술공학", id: "s-26" },
        
        // --- ★ 신규 추가된 단답형 문제 (과학 윤리 분야별 사례) ---
        { type: "short", q: "안락사, 동물 실험, 배아 연구, 맞춤 아기, 인공 수정, 냉동 인간 등과 관련된 과학 윤리의 구분 분야는?", a: "생명윤리", id: "s-27" },
        { type: "short", q: "유전자 재조합, 줄기세포 연구, 유전자 변형 생물, 인간 복제 등과 관련된 과학 윤리의 구분 분야는?", a: "유전공학", id: "s-28" },
        { type: "short", q: "나노 기술, 로봇, 식량 자원, 우주 항해, 우주 탐사선의 핵연료, 드론 사용 범위 등과 관련된 과학 윤리의 구분 분야는?", a: "기술공학", id: "s-29" },
        { type: "short", q: "기후 변화, 지구 온난화, 탄소 배출권, 자원 개발, 댐 건설, 미세 먼지, 생물종 감소, 광공해, 독성 화학 물질의 농축, 수돗물의 불소화 등과 관련된 과학 윤리의 구분 분야는?", a: "환경,생태계", id: "s-30" },
        { type: "short", q: "핵발전, 핵발전 사고, 방사성 폐기물, 해양 자원의 이용 등과 관련된 과학 윤리의 구분 분야는?", a: "에너지", id: "s-31" },
        { type: "short", q: "현대 의약품 개발, 성장 호르몬, 비만과 다이어트, 항생재 남용 등과 관련된 과학 윤리의 구분 분야는?", a: "의료,질병", id: "s-32" },
        { type: "short", q: "표절, 정신이상의 처벌, 과속과 교통사고 등과 관련된 과학 윤리의 구분 분야는?", a: "법,도덕", id: "s-33" },
        { type: "short", q: "지구촌 혐오, 환경 호르몬, 가상현실, 급발진 사고, 전자파 피해 등과 관련된 과학 윤리의 구분 분야는?", a: "기타", id: "s-34" },
        
        // --- 기존 서술형 문제 (11개) ---
        { type: "essay", q: "인공지능 로봇의 활용 예시 중, 공장에서의 활용과 그 효과를 서술하시오.", a: "공장에서 반복적이고 위험한 작업을 수행합니다. 이를 통해 생산 효율성이 향상되고, 위험한 일에 실시간으로 적절하게 대처할 수 있습니다.", id: "e-1" },
        { type: "essay", q: "스마트팜(농업)에서 사물 인터넷 기술이 적용되는 구체적인 예시 3가지를 학습지 내용을 바탕으로 서술하시오.", a: "1. 토양 센서를 이용하여 수분량, pH 농도, 온도 등을 측정하고, 기상 센서는 온도, 습도, 일사량, 강우 등을 모니터링 함.\n2. 자동 관개 시스템을 이용하여 필요한 양의 수분을 공급함.\n3. 작물의 영양 상태를 모니터링하고 필요한 비료와 영양소를 공급함.", id: "e-2" },
        { type: "essay", q: "바리스타 로봇의 장점 5가지를 모두 서술하시오.", a: "1. 일관된 품질, 균일한 맛.\n2. 효율성, 인간보다 빠름.\n3. 비용 절감, 쉬지 않고 일함.\n4. 위생, 위생적 환경 관리.\n5. 다양성, 다양한 메뉴 가능.", id: "e-3" },
        { type: "essay", q: "바리스타 로봇의 단점 4가지와 이에 대한 개선 방안 3가지 이상을 서술하시오.", a: "단점: 초기비용이 비쌈, 프로그램된 것만 만듬, 고장이나 오류 발생 가능, 객과 상호 작용이 없음.\n개선 방안: 음성 인식 프로그램 추가 (고객과 의사 소통), 커피 외에도 다양한 음료 제공, 사람과 비슷하게 팔과 얼굴을 만들어 간단한 표정을 지을 수 있도록 함, 로봇 운영을 위한 전문 인력 필요.", id: "e-4" },
        { type: "essay", q: "인공지능 기술 발전의 한계 6가지와 정보 통신 기술 발전의 한계 4가지를 각각 서술하시오.", a: "인공지능 기술의 한계: 1. 프라이버시 침해, 2. 편견과 차별, 3. 일자리 감소, 4. 디지털 격차 발생, 5. 해킹 등 사이버 보안 위험, 6. 인공지능의 오남용.\n정보 통신 기술의 한계: 1. 정보 과부하, 2. 인터넷 중독, 3. 감시 사회, 4. 윤리적 갈등.", id: "e-5" },
        { type: "essay", q: "오래된 핵 발전소의 가동 중단에 대한 '찬성' 입장과 '반대' 입장의 주된 근거를 각각 서술하시오.", a: "찬성: 가동 연한을 넘어서 가동하는 것은 위험하다.\n반대: 핵 발전으로 전기 에너지를 저렴하게 생산할 수 있으므로 바로 중단하면 경제적 손실이 크다.", id: "e-6" },
        { type: "essay", q: "유전자 변형 생물의 재배에 대한 '찬성' 입장과 '반대' 입장의 주된 근거를 각각 서술하시오.", a: "찬성: 유전자 변형 생물은 질병에도 강하고 수확량도 많아 인류의 식량 문제를 해결할 수 있다.\n반대: 유전자 변형 생물이 인간에게 어떤 영향을 미치는지 구체적으로 연구되어 있지 않으므로 재배를 제한해야 한다.", id: "e-7" },
        { type: "essay", q: "신재생 에너지 활용 확대에 대한 '찬성' 입장과 '반대' 입장의 주된 근거를 각각 서술하시오.", a: "찬성: 신재생 에너지 활용을 확대하면 환경 오염 물질의 배출이 줄어 지구 환경을 보호할 수 있다.\n반대: 초기 비용이 많이 들고, 발전 과정에서 주변 환경의 영향을 받아 안정적으로 전기를 생산하기 어려우므로 주력 에너지원으로 적합하지 않다.", id: "e-8" },
        { type: "essay", q: "동물 실험에 대한 '찬성' 입장과 '반대' 입장의 주된 근거를 각각 서술하시오.", a: "찬성: 의약품, 화장품 등을 생산할 때 인간이 직접 실험 대상이 될 수 없으므로 동물 실험은 반드시 필요하다.\n반대: 안정성을 충분히 확보해 불필요한 동물 실험을 줄여야 한다.", id: "e-9" },
        { type: "essay", q: "과학 관련 사회적 쟁점에 대한 '합리적 의사 결정'을 위해 필요한 과정을 서술하시오.", a: "다양한 관점과 복잡한 상황을 과학적으로 이해하고, 충분한 토론을 거쳐 합리적으로 의사 결정을 내릴 수 있어야 한다.", id: "e-10" },
        { type: "essay", q: "과학기술이 바람직하게 발전하기 위해 과학 윤리를 지켜야 하는 이유를 서술하시오.", a: "과학 기술의 발전이 가져올 과학 관련 사회적 쟁점을 예측하기 어렵기 때문에, 윤리적 태도를 갖추어 과학 기술이 긍정적으로 발전할 수 있도록 노력해야 한다.", id: "e-11" },
        
        // --- ★ 신규 추가된 서술형 문제 (과학 윤리 분야별 사례) ---
        { type: "essay", q: "생명윤리의 중요성이 요구되는 사례를 모두 서술하시오.", a: "안락사, 동물 실험, 배아 연구, 맞춤 아기, 인공 수정, 냉동 인간 등", id: "e-12" },
        { type: "essay", q: "유전공학의 중요성이 요구되는 사례를 모두 서술하시오.", a: "유전자 재조합, 줄기세포 연구, 유전자 변형 생물, 인간 복제 등", id: "e-13" },
        { type: "essay", q: "기술공학의 중요성이 요구되는 사례를 모두 서술하시오.", a: "나노 기술, 로봇, 식량 자원, 우주 항해, 우주 탐사선의 핵연료, 드론 사용 범위 등", id: "e-14" },
        { type: "essay", q: "환경, 생태계 분야에서 과학 윤리의 중요성이 요구되는 사례를 모두 서술하시오.", a: "기후 변화, 지구 온난화, 탄소 배출권, 자원 개발, 댐 건설, 미세 먼지, 생물종 감소, 광공해, 독성 화학 물질의 농축, 수돗물의 불소화 등", id: "e-15" },
        { type: "essay", q: "에너지 분야에서 과학 윤리의 중요성이 요구되는 사례를 모두 서술하시오.", a: "핵발전, 핵발전 사고, 방사성 폐기물, 해양 자원의 이용 등", id: "e-16" },
        { type: "essay", q: "의료, 질병 분야에서 과학 윤리의 중요성이 요구되는 사례를 모두 서술하시오.", a: "현대 의약품 개발, 성장 호르몬, 비만과 다이어트, 항생재 남용 등", id: "e-17" },
        { type: "essay", q: "법, 도덕 분야에서 과학 윤리의 중요성이 요구되는 사례를 모두 서술하시오.", a: "표절, 정신이상의 처벌, 과속과 교통사고 등", id: "e-18" },
        { type: "essay", q: "기타 분야에서 과학 윤리의 중요성이 요구되는 사례를 모두 서술하시오.", a: "지구촌 혐오, 환경 호르몬, 가상현실, 급발진 사고, 전자파 피해 등", id: "e-19" },
    ];

    let shortQuizData = [];
    let essayQuizData = [];

    // --- 오답 노트 상태 관리 ---
    let shortIncorrect = []; 
    let essayIncorrect = [];
    let reviewShuffled = [];

    // --- 퀴즈 상태 관리 ---
    let currentMode = 'short'; // 현재 모드: 'short', 'essay', 'review'
    const quizState = {
        short: { index: 0, score: 0, shuffled: [] },
        essay: { index: 0, score: 0, shuffled: [] },
        review: { index: 0, score: 0, total: 0 }
    };

    let isAnswerChecked = false; // 정답 확인 상태 플래그

    // --- 문제 데이터 초기화 및 생성 ---
    function initializeQuizData() {
        // 기존 문제 데이터 분류
        shortQuizData = sourceQuizData.filter(q => q.type === 'short');
        essayQuizData = sourceQuizData.filter(q => q.type === 'essay');

        // 단답형 문제를 역산하여 서술형 문제로 변환 및 ID 부여 
        sourceQuizData.filter(q => q.type === 'short').forEach(q => {
            const reversedQ = `다음 과학기술/개념에 대해 서술하시오. (${q.a})`;
            const reversedA = q.q; 
            // 단답형이었던 문제는 다시 서술형으로 만들어서 essayQuizData에 추가
            essayQuizData.push({
                type: 'essay',
                q: reversedQ,
                a: reversedA,
                id: `e-rev-${q.id.split('-')[1]}` 
            });
        });
        
        // 초기 셔플
        quizState.short.shuffled = shuffleArray([...shortQuizData]);
        quizState.essay.shuffled = shuffleArray([...essayQuizData]);

        updateReviewCount();
    }

    // Fisher-Yates 셔플 알고리즘
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // 오답 노트 탭의 문제 개수 업데이트
    function updateReviewCount() {
        const totalIncorrect = shortIncorrect.length + essayIncorrect.length;
        document.getElementById('review-tab-btn').textContent = `오답 노트 (${totalIncorrect})`;
        quizState.review.total = totalIncorrect;
    }

    // 오답 노트 배열에 문제가 이미 있는지 확인
    function isAlreadyIncorrect(question) {
        const incorrectArray = question.type === 'short' ? shortIncorrect : essayIncorrect;
        return incorrectArray.some(q => q.id === question.id);
    }

    // 오답 노트 배열에서 문제 제거 (오답 재풀이 시 정답 맞췄을 때)
    function removeIncorrect(question) {
        if (question.type === 'short') {
            shortIncorrect = shortIncorrect.filter(q => q.id !== question.id);
        } else {
            essayIncorrect = essayIncorrect.filter(q => q.id !== question.id);
        }
        updateReviewCount();
    }

    // --- 탭 모드 변경 ---
    function setMode(mode) {
        if (currentMode === mode) return;

        currentMode = mode;
        
        // 탭 버튼 스타일 변경
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${mode}-tab-btn`).classList.add('active');

        // 오답 노트 모드 시작 시 준비
        if (mode === 'review') {
            startReviewMode();
            return;
        }

        // 퀴즈 상태 초기화 및 로드
        loadQuestion();
        document.getElementById('final-score').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';
        document.getElementById('control-panel').style.display = 'block';
    }
    
    // 오답 노트 모드 설정
    function startReviewMode() {
        if (quizState.review.total === 0) {
            document.getElementById('quiz-status').textContent = '오답 노트가 비어있어! 메인 퀴즈에서 틀린 문제를 먼저 만들어 봐.';
            document.getElementById('question-text').textContent = '문제가 없어!';
            document.getElementById('answer-input').style.display = 'none';
            document.getElementById('essay-input-area').style.display = 'none';
            document.getElementById('check-button').style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
            document.getElementById('result-text').textContent = '';
            document.getElementById('quiz-area').style.display = 'block';
            document.getElementById('final-score').style.display = 'none';
            return;
        }

        // 오답 문제를 모아서 섞음
        const combinedIncorrect = [...shortIncorrect, ...essayIncorrect];
        reviewShuffled = shuffleArray(combinedIncorrect);
        
        quizState.review.index = 0; 
        quizState.review.score = 0;

        document.getElementById('quiz-area').style.display = 'block';
        document.getElementById('final-score').style.display = 'none';
        document.getElementById('control-panel').style.display = 'block';
        loadQuestion();
    }

    // --- 퀴즈 로드 ---
    function loadQuestion() {
        const state = quizState[currentMode];
        let currentQuestion, totalQuestions;

        if (currentMode === 'review') {
            totalQuestions = reviewShuffled.length;
            if (state.index >= totalQuestions) {
                showFinalScore();
                return;
            }
            currentQuestion = reviewShuffled[state.index];
            document.getElementById('quiz-status').textContent = 
                `오답 노트 문제 ${state.index + 1} / ${totalQuestions} (맞춘 개수: ${state.score}개)`;
        } else {
            totalQuestions = state.shuffled.length;
            if (state.index >= totalQuestions) {
                showFinalScore();
                return;
            }
            currentQuestion = state.shuffled[state.index];
            document.getElementById('quiz-status').textContent = 
                `${currentMode === 'short' ? '단답형' : '서술형'} 문제 ${state.index + 1} / ${totalQuestions} (현재 점수: ${state.score}점)`;
        }
        
        // 문제 내용 업데이트
        document.getElementById('question-text').textContent = 
            `[${currentQuestion.type === 'short' ? '단답형' : '서술형'}] ${currentQuestion.q}`;
        
        // 입력/결과 초기화
        document.getElementById('result-text').textContent = '';
        document.getElementById('result-text').className = 'result';
        document.getElementById('answer-input').value = '';
        document.getElementById('essay-user-answer').value = '';
        document.getElementById('essay-answer-box').style.display = 'none';

        // 유형에 따라 입력 필드 토글 (현재 문제의 유형을 따름)
        const isShortQuestion = currentQuestion.type === 'short';
        document.getElementById('answer-input').style.display = isShortQuestion ? 'block' : 'none';
        document.getElementById('essay-input-area').style.display = isShortQuestion ? 'none' : 'block';

        // 버튼 및 상태 초기화
        document.getElementById('check-button').style.display = 'inline-block';
        document.getElementById('check-button').disabled = false;
        document.getElementById('next-button').style.display = 'none';
        document.getElementById('answer-input').disabled = false;
        document.getElementById('essay-user-answer').disabled = false;
        const essayButtons = document.getElementById('essay-score-buttons');
        if (essayButtons) essayButtons.style.display = 'block';
        isAnswerChecked = false;
        
        // **********************************************
        // 핵심 수정 사항: 다음 문제 로드 시 입력 필드에 바로 포커스
        // **********************************************
        setTimeout(() => {
            const inputField = isShortQuestion 
                ? document.getElementById('answer-input') 
                : document.getElementById('essay-user-answer');
            
            // 기존에 포커스된 요소(특히 '다음 문제' 버튼)가 있다면 해제하고 포커스 이동
            if (document.activeElement) {
                document.activeElement.blur();
            }
            
            // 입력 필드가 실제로 화면에 보일 때 포커스를 줘야 함
            if (inputField && inputField.style.display !== 'none') {
                 inputField.focus();
            }
        }, 0); // 0ms delay로 DOM 업데이트 후 즉시 실행 보장
        // **********************************************
    }

    // --- 정답 확인 핸들러 ---
    function handleCheck() {
        if (isAnswerChecked) return;
        
        // 현재 모드 대신 현재 문제의 유형을 따라감 (오답 노트에 단답/서술 섞여있으므로)
        const currentQuestion = currentMode === 'review' 
            ? reviewShuffled[quizState.review.index] 
            : quizState[currentMode].shuffled[quizState[currentMode].index];

        if (currentQuestion.type === 'short') {
            checkShortAnswer(currentQuestion);
        } else { // essay
            showEssayAnswer(currentQuestion);
        }
    }

    // 단답형 자동 채점
    function checkShortAnswer(currentQuestion) {
        const state = quizState[currentMode];
        const userAnswer = document.getElementById('answer-input').value.replace(/\s/g, '').toLowerCase();
        const correctAnswer = currentQuestion.a.replace(/\s/g, '').toLowerCase();
        const resultText = document.getElementById('result-text');
        
        let isCorrect = (userAnswer === correctAnswer);

        if (isCorrect) {
            resultText.textContent = '정답입니다!';
            resultText.classList.add('correct');
            if (currentMode !== 'review') state.score++;
        } else {
            resultText.textContent = `오답입니다! 정답: ${currentQuestion.a}`;
            resultText.classList.add('incorrect');
            // 오답 노트에 추가 (메인 퀴즈 모드일 때만)
            if (currentMode !== 'review' && !isAlreadyIncorrect(currentQuestion)) {
                shortIncorrect.push(currentQuestion);
                updateReviewCount();
            }
        }
        
        // 오답 노트 모드에서 정답을 맞췄으면 오답 리스트에서 제거
        if (currentMode === 'review' && isCorrect) {
            removeIncorrect(currentQuestion);
            state.score++; // 오답 노트에서 맞춘 개수 증가
        }

        document.getElementById('answer-input').disabled = true;
        transitionToNextState(true);
    }

    // 서술형 모범 답안 표시 (자가 채점 시작)
    function showEssayAnswer(currentQuestion) {
        document.getElementById('essay-user-answer').disabled = true;
        
        const answerBox = document.getElementById('essay-answer-box');
        document.getElementById('essay-correct-answer').textContent = currentQuestion.a;
        answerBox.style.display = 'block';

        const resultText = document.getElementById('result-text');
        resultText.textContent = '모범 답안과 비교 후 정답 여부를 선택해주세요.';
        resultText.className = 'result';

        document.getElementById('check-button').disabled = true;
    }

    // 서술형 자가 채점 결과 반영
    function setEssayResult(isCorrect) {
        const state = quizState[currentMode];
        const resultText = document.getElementById('result-text');
        
        // 현재 문제 가져오기
        const currentQuestion = currentMode === 'review' 
            ? reviewShuffled[quizState.review.index] 
            : quizState[currentMode].shuffled[quizState[currentMode].index];

        if (isCorrect) {
            resultText.textContent = 'O (맞음)으로 채점되었습니다. 잘했어요!';
            resultText.classList.add('correct');
            if (currentMode !== 'review') state.score++;
            
            // 오답 노트 모드에서 정답을 맞췄으면 오답 리스트에서 제거
            if (currentMode === 'review') {
                removeIncorrect(currentQuestion);
                state.score++; // 오답 노트에서 맞춘 개수 증가
            }
        } else {
            resultText.textContent = 'X (틀림)으로 채점되었습니다. 정답을 확인하세요!';
            resultText.classList.add('incorrect');
            
            // 오답 노트에 추가 (메인 퀴즈 모드일 때만)
            if (currentMode !== 'review' && !isAlreadyIncorrect(currentQuestion)) {
                essayIncorrect.push(currentQuestion);
                updateReviewCount();
            }
        }

        transitionToNextState(true);
    }

    // 다음 문제 상태로 전환
    function transitionToNextState(focusNext = false) {
        isAnswerChecked = true;
        document.getElementById('check-button').style.display = 'none';
        document.getElementById('next-button').style.display = 'inline-block';
        
        if (currentMode !== 'short') {
            const essayButtons = document.getElementById('essay-score-buttons');
            if (essayButtons) essayButtons.style.display = 'none';
        }

        if (focusNext) {
            document.getElementById('next-button').focus();
        }
    }

    // 다음 문제로 이동
    function nextQuestion() {
        if (!isAnswerChecked) return;
        quizState[currentMode].index++;
        loadQuestion();
    }
    
    // 오답 노트 초기화 기능
    function resetIncorrectAnswers() {
        if (shortIncorrect.length === 0 && essayIncorrect.length === 0) {
            alert("오답 노트가 이미 비어있어!");
            return;
        }
        
        if (confirm("정말로 오답 노트에 저장된 모든 문제를 초기화할 거야?")) {
            shortIncorrect = [];
            essayIncorrect = [];
            reviewShuffled = [];
            updateReviewCount();
            alert("오답 노트가 깨끗하게 초기화되었어!");
            
            // 현재 모드가 'review'였다면 다시 로드
            if (currentMode === 'review') {
                setMode('short'); // 초기화 후 단답형 모드로 이동
            }
        }
    }

    // 최종 점수 표시
    function showFinalScore() {
        const finalScoreDiv = document.getElementById('final-score');
        const state = quizState[currentMode];
        const totalQuestions = currentMode === 'review' ? state.total : state.shuffled.length;
        const quizType = currentMode === 'short' ? '단답형' : (currentMode === 'essay' ? '서술형' : '오답 노트');
        
        let scoreText;

        if (currentMode === 'review') {
             const remaining = reviewShuffled.length - state.index;
             scoreText = `총 ${totalQuestions} 문제 중 ${state.score} 문제를 맞췄고, 아직 ${remaining} 문제가 남아있어.`;
        } else {
             const percentage = ((state.score / totalQuestions) * 100).toFixed(1);
             scoreText = `총 ${totalQuestions} 문제 중 <strong>${state.score}문제</strong> 정답! 정답률: <strong>${percentage}%</strong>`;
        }


        finalScoreDiv.innerHTML = `
            <h2>${quizType} 퀴즈 종료!</h2>
            <p>${scoreText}</p>
            <button class="quiz-button" style="background-color: #4CAF50; color: #1a1a1a; margin-top: 20px;" onclick="startGame()">새로운 퀴즈 시작하기 (섞기)</button>
        `;
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('control-panel').style.display = 'none';
        finalScoreDiv.style.display = 'block';
    }

    // --- 키보드 이벤트 핸들러 ---
    document.addEventListener('keydown', function(event) {
        if (document.getElementById('final-score').style.display === 'block') {
            return;
        }

        if (event.key === 'Enter') {
            event.preventDefault();

            // 현재 포커스된 요소가 서술형 버튼이면 아무것도 하지 않음 (자가 채점 방해 방지)
            if (document.activeElement.classList.contains('essay-score-btn')) {
                return;
            }

            if (!isAnswerChecked) {
                handleCheck();
            } else {
                nextQuestion();
            }
        } else if (event.key === ' ' && isAnswerChecked) {
            event.preventDefault(); 
            nextQuestion();
        }
    });

    // --- 퀴즈 시작 ---
    function startGame() {
        initializeQuizData(); // 데이터 초기화 및 서술형 문제 생성
        // 상태 초기화
        quizState.short.index = 0; quizState.short.score = 0;
        quizState.essay.index = 0; quizState.essay.score = 0;
        quizState.review.index = 0; quizState.review.score = 0;
        
        // 기본 모드인 'short'로 설정
        setMode('short');
        
        document.getElementById('control-panel').style.display = 'block';
    }

    window.onload = startGame;
</script>

</body>
</html>
